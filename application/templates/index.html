{% extends 'base.html' %}

{% block head %}
<title>HL7 Extractor</title>
{% endblock %}

{% block body %}

<div class="content pb-5" style="width: 50%;" >
    <div style="text-align: center"><h1>HL7 Extractor</h1>
        <button id="toggle" onclick="toggleForm()" type="button"></button>
    </div>
    
    <div class="form" id="form">
        <form action="/" method="POST">
            <textarea type="text" name="content" id="content" style="width: 100%;" rows="15" placeholder="Enter HL7 message..."></textarea>
            <div class="" style="float: right;">
                <input type="submit" value="Add Message">
            </div>
        </form>
    </div>
</div>

<div class="output-container">
    <hr/>
    {% if not messages %}
    <h4 style="text-align: center">There are no messages. Create one above!</h4>
    {% else %}

    <div class="" style="display: flex; justify-content: space-between;align-items: center;">
        <div class="" style="display: flex; gap: 5px;align-items: center;">
            <a href="/" style="background-color: ButtonFace; color: black; padding: 2px 5px;border: solid 1px black;text-decoration: none;">Reset Filter</a>
            <div class="pl-5"><strong>Filter By:</strong>
                <select name="filterBy" id="filterBy" style="margin-top: 2px;padding-right: 5px;" onchange="changeFilter(event)">
                    <option value="day">Day</option>
                    <option value="year">Year</option>
                    <option value="month">Month</option>
                </select>
            </div>
            <div class="">
                
                <form id="dayForm" action="/" method="GET">
                    <input id="day" name="day" type="date" onchange="filterDay(event)" value="{{ day }}">
                    
                </form>

                <form id="monthForm" action="/" method="GET">
                    <input id="month" name="month" type="month" onchange="filterMonth(event)" value="{{ month }}">
                </form>

                <form id="yearForm" action="/" method="GET">
                    <select id="year" name="year" style="margin-top: 2px;padding-right: 5px;" onchange="filterYear(event)">
                        {% if not year %}
                        <option value="" disabled selected></option>
                        {% endif %}

                        {% for current_year in range(2000, 2026)|reverse %}
                            {% if year == current_year|string %}
                            <option value="{{year}}" selected>{{year}}</option>
                            {% else %}
                            <option value="{{current_year}}">{{current_year}}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </form>
            </div>
            <div class="pl-5">
                <div class="" style="display: flex;align-items: center; gap: 5px;">
                    <strong>Sort By:</strong>
                    <select name="order" id="order" style="margin-top: 0px;" onchange="sortDate(event)">
                        <option value="latest">Latest</option>
                        {% if sortBy == "oldest" %}
                        <option value="oldest" selected>Oldest</option>
                        {% else %}
                        <option value="oldest">Oldest</option>
                        {% endif %}
                    </select>
                </div>
            </div>
        </div>
        <div class="messages">
            <div class="pagination">
            {% if messages.has_prev %}
                <a class="page-number" onclick="return navigatePage({{ messages.prev_num }})" href="#">&lt;</a> 
            {% endif %}

            {% for number in messages.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
                {% if number %}
                    {% if messages.page != number %}
                        <a class="page-number" onclick="return navigatePage({{ number }})" href="#">{{number}}</a>
                    {% else %}
                        <span class='current-page-number'>{{ number }}</span>
                    {% endif %}
                {% else %}
                    ...
                {% endif %}
            {% endfor %}

            {% if messages.has_next %}
                <a class="page-number" onclick="return navigatePage({{ messages.next_num }})" href="#">&gt;</a>
            {% endif %}

            </div>

            {% if messages.pages > 0 %}
            <div class="total-pages">
                Page {{ messages.page }} of {{ messages.pages }}
            </div>
            {% endif %}
        </div>
    </div>

    <table>
        <thead>
            <tr class="bg-primary text-white"></tr>
                <th colspan="5">Raw Data</th>
                <th class="text-center">Added On</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% if messages.pages > 0 %}
                {% for message in messages %}
                <tr>
                    <td colspan="5" style="word-wrap: break-word;overflow: hidden;text-wrap: nowrap;">
                        <div style="display: flex;column-gap: 5px;">
                            <div class="" style="font-weight: 600;">{{ message.id }}.</div>
                            <div class="" style="flex-grow: 1;">{{ message.content }}</div>
                        </div>
                    </td>
                    <td class="text-center">{{ message.date_created.date() }}</td>
                    <td class="text-center">
                        <a class="text-dark" href="/result/{{message.id}}" onclick="setLinkURL()"><u>Extract</u></a>
                        <div class="">
                        <a class="text-primary" href="/update/{{message.id}}"><u>Update</u></a>
                        </div>
                        <form action="/delete/{{message.id}}" method="POST"></form>
                            <button class="text-danger" type="submit" onclick="confirmDelete(event)" id="{{message.id}}">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
            <tr>
                <td colspan="7" style="text-align: center;">
                    <div class="" style="height: 100px;display: flex;flex-direction: column;justify-content: center;">
                        <p style="font-size: 18px;">There are no records found...</p>
                    </div>
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    {% endif %}
</div>


{% endblock %}